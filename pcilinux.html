<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>devLib2: PCI Access in Linux</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">devLib2
   &#160;<span id="projectnumber">2.11</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PCI Access in Linux </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The PCI bus implementation for Linux uses the Userspace IO kernel API to access the bus. Devices needing only memory mapped I/O access do not require a kernel driver. To support PCI style interrupts a minimal kernel module using the Linux UIO framework is required. Devices which implement generic interrupt enable/disable via the PCI control register may user the generic 'uio_pci_generic' kernel module. Otherwise this must either be written for each device to be supported.</p>
<h1><a class="anchor" id="shouldi"></a>
When to Use</h1>
<p>It is important to consider writing a full kernel module. The advantage of the UIO interface is simpler development with access to userspace tools and safeguards. Also compatibility with RTEMS and vxWorks. The disadvantage is increased latency, being forced to be compatible with RTEMS and vxWorks, and being restricted in use to EPICS code.</p>
<p>It is likely that devices needing low latency, high throughput, or access to features like DMA would be better served by writing a full kernel module.</p>
<h1><a class="anchor" id="hwrequire"></a>
Hardware Requirements</h1>
<p>When servicing interrupts from a userspace process it is not possible to globally disable interrupts. Thus it is not possible to rely on epicsInterruptLock() when accessing resources which must be shared between kernel and user-space.</p>
<p>This makes it difficult to perform read-modify-write operations on shared registers. This can be an intractable problem for a device which implements its interrupt enable register as a bit mask.</p>
<p>When evaluating hardware for the suitability look for an interrupt mask register and status register.</p>
<p>This should not be an issue for devices having a single interrupt condition. Devices using PCI to local bus bridges like the PLX PCI9030 should be usable. Also, devices supporting version 2.3 or greater of PCI standard can make use of the standard master interrupt enable/status bits in the control and status registers.</p>
<h1><a class="anchor" id="udev"></a>
UDEV rules</h1>
<p>To allow IOCs to run with minimal privlages it is advisable to change the permissions of the special files use by devlib2. This can be done either manually, or by configuring the UDEV daemon.</p>
<p>When attempting to make use of a PCI devices, devlib2 will attempt to access several files.</p>
<ul>
<li>/sys/bus/pci/devices/000:BB:DD.F/resource#</li>
</ul>
<p>The "resource*" files exist one for each BAR. <a class="el" href="group__pci.html#gad7c075a2769f5e93cb9f4d567346c7f1" title="Get pointer to PCI BAR. ">devPCIToLocalAddr()</a> will first attempt to open the corresponding file.</p>
<ul>
<li>/sys/bus/pci/devices/000:BB:DD.F/uio:uio# (Linux &lt;= 2.6.28) </li>
<li>/sys/bus/pci/devices/000:BB:DD.F/uio/uio# (Linux &gt;= 2.6.32)</li>
</ul>
<p>These are possible locations of symlinks to "/dev/uio#". <a class="el" href="group__pci.html#gad7c075a2769f5e93cb9f4d567346c7f1" title="Get pointer to PCI BAR. ">devPCIToLocalAddr()</a> will next attempt to open each in turn, then map the a region corresponding to the BAR number, or the number of mappings when the DEVLIB_MAP_UIOCOMPACT flag is given.</p>
<p>In this example, the permissions of /resource0 are changed.</p>
<div class="fragment"><div class="line">SUBSYSTEM==<span class="stringliteral">&quot;pci&quot;</span>, ATTR{vendor}==<span class="stringliteral">&quot;0x1234&quot;</span>, ATTR{device}==<span class="stringliteral">&quot;0x1234&quot;</span>, RUN+=<span class="stringliteral">&quot;/bin/chmod a+rw %S%p/resource0&quot;</span></div></div><!-- fragment --><p>And for a UIO device</p>
<div class="fragment"><div class="line">SUBSYSTEM==<span class="stringliteral">&quot;pci&quot;</span>, ATTR{vendor}==<span class="stringliteral">&quot;0x1234&quot;</span>, ATTR{device}==<span class="stringliteral">&quot;0x1234&quot;</span>, MODE=<span class="stringliteral">&quot;0666&quot;</span></div></div><!-- fragment --><p>To discover possible attributes for matching use "udevadm info" and look for the first SUBSYSTEM=="pci" paragraph.</p>
<div class="fragment"><div class="line">udevadm info -a -p $(udevadm info -q path -n /<a class="code" href="structbdf.html#a5117a88e7f061f95bfae31b7ef92a835">dev</a>/uio0) --attribute-walk</div></div><!-- fragment --><p>If not device file exists, then the PCI geographic address can be used</p>
<div class="fragment"><div class="line">udevadm info -a -p /bus/pci/devices/0000:0<a class="code" href="structbdf.html#a04f6e3ed663b23b8be98a2f819173744">b</a>:00.0 --attribute-walk</div></div><!-- fragment --><p>The effects of a new rules file can be tested with "udevadm -a add test".</p>
<div class="fragment"><div class="line">udevadm test -a add /bus/pci/devices/0000:0<a class="code" href="structbdf.html#a04f6e3ed663b23b8be98a2f819173744">b</a>:00.0</div><div class="line">udevadm test -a add $(udevadm info -q path -n /<a class="code" href="structbdf.html#a5117a88e7f061f95bfae31b7ef92a835">dev</a>/uio0)</div></div><!-- fragment --><h1><a class="anchor" id="linuxrefs"></a>
References</h1>
<p>More information on writing UIO kernel modules can be found:</p>
<dl class="section see"><dt>See also</dt><dd><a href="http://www.kernel.org/doc/htmldocs/uio-howto.html">http://www.kernel.org/doc/htmldocs/uio-howto.html</a> </dd>
<dd>
<a href="http://lwn.net/Articles/232575/">http://lwn.net/Articles/232575/</a></dd></dl>
<p>The kernel source tree contains several example drivers.</p>
<dl class="section see"><dt>See also</dt><dd><a href="http://lxr.linux.no/#linux+v2.6.35/drivers/uio/uio_cif.c">http://lxr.linux.no/#linux+v2.6.35/drivers/uio/uio_cif.c</a> </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
