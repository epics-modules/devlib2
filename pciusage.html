<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>devLib2: PCI Usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">devLib2
   &#160;<span id="projectnumber">2.11</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">devLib2 MMIO Bus Access Library</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PCI Usage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>When working with a PCI device the first step is finding the identifiers used by the device. These will likely be included in the card vendor's documentation, but can be verified by observing the OS boot messages or with the <a class="el" href="group__pci.html#ga1fe729e716ec1cb1a709c05f59c3c879">devPCIShow()</a> function.</p>
<p>Including this identifying information in your code provides an important safe guard against user mis-configuration. This provides an easy way to prevent your code from trying to access the wrong type of device.</p>
<p>PCI devices are uniquely identified by the triplet bus:device.function. While it is possible to automatically detect cards it is preferable to have a user defined mapping between physical id (b:d.f) and logical id (Asyn port, device ID, etc.). This allows for consistent naming even if cards are added or removed from the system.</p>
<p>For EPICS drivers initialization will usually be done with an IOC shell function. For example:</p>
<div class="fragment"><div class="line">myPCICardSetup(<span class="stringliteral">&quot;dac&quot;</span>, 2, 1, 0 )</div></div><!-- fragment --><p>Would set card "dac" to be function 0 of device 1 on bus 2. Since all PCI devices will be automatically configured by the system this is the only piece of information required to access the card.</p>
<p>Below is an example implementation of myPCICardSetup().</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="structepics_p_c_i_i_d.html">epicsPCIID</a> mydevids[] = {...}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">myPCICardSetup(<span class="keyword">const</span> <span class="keywordtype">char</span>* port,</div><div class="line">               <span class="keywordtype">int</span> <a class="code" href="structbdf.html#a04f6e3ed663b23b8be98a2f819173744">b</a>,</div><div class="line">               <span class="keywordtype">int</span> <a class="code" href="structbdf.html#a20a6b3d5eaed737273aa2aad9b7a3024">d</a>,</div><div class="line">               <span class="keywordtype">int</span> <a class="code" href="structbdf.html#aeab209cc6ec62a2948e79ccd9d61bc58">f</a>)</div><div class="line">{</div><div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">void</span>* bar;</div><div class="line">    <a class="code" href="structepics_p_c_i_device.html">epicsPCIDevice</a> *<a class="code" href="structbdf.html#a5117a88e7f061f95bfae31b7ef92a835">dev</a>;</div><div class="line">    devpriv *priv;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>( portExists(port) ) <span class="keywordflow">return</span> 1;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__pci.html#ga73a361135c19a7e638360c24f0ea0e7a">devPCIFindBDF</a>(mydevids, b,d,f, &amp;dev, 0))</div><div class="line">        <span class="keywordflow">return</span> 2;</div></div><!-- fragment --><p>The first step is to probe the PCI location to ensure that the card is present. If the location is empty or populated with an unsupported card then we will abort here.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__pci.html#gad7c075a2769f5e93cb9f4d567346c7f1">devPCIToLocalAddr</a>(dev, 2, &amp;bar, 0))</div><div class="line">    <span class="keywordflow">return</span> 3;</div></div><!-- fragment --><p>Next we get a pointer for bar #2.</p>
<div class="fragment"><div class="line">priv=calloc(1, <span class="keyword">sizeof</span>(mydevpriv));</div><div class="line"><span class="keywordflow">if</span> (!priv) <span class="keywordflow">return</span> 4;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__pci.html#gaf9dc1d0b50cf4184e1c4c3ace4900cfa">devPCIConnectInterrupt</a>(dev, &amp;myisr, priv))</div><div class="line">    <span class="keywordflow">return</span> 5;</div></div><!-- fragment --><p>Then connect the interrupt service routine.</p>
<div class="fragment"><div class="line">    portCreate(port, priv);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>And that is it.</p>
<h1><a class="anchor" id="pciiotypes"></a>
Note on PCI I/O Types</h1>
<p>The PCI bus has the notion of two different I/O address types: Memory Mapped, and Port. This distinction comes from the x86 processor for which these are two separate address spaces which must be accessed using different instructions (load/store vs. out/in).</p>
<p>Each BAR must either be accessed using Memory Mapped I/O (MMIO), or Port I/O (PIO) operations. This can be determined by inspecting the 'ioport' member of the <a class="el" href="struct_p_c_i_bar.html">PCIBar</a> structure.</p>
<p>If the value is false (0) then <a class="el" href="group__mmio.html">MMIO operations</a> should be used.</p>
<p>If however, the value is true (1) then the pointer returned by <a class="el" href="group__pci.html#gad7c075a2769f5e93cb9f4d567346c7f1" title="Get pointer to PCI BAR. ">devPCIToLocalAddr()</a> needs to be treated as a PIO address. It should be cast to the appropriate type and access using OS defined PIO operations (ie inb/outb). </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
